<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="">
      <meta name="keywords" content="">
      <meta name="author" content="">
      <title>
         $ - Dashboard
      </title>
      <link href="assets/css/toolkit-inverse.css" rel="stylesheet">
      <link href="assets/css/application.css" rel="stylesheet">
      <style>
         /* note: this is a hack for ios iframe for bootstrap themes shopify page */
         /* this chunk of css is not part of the toolkit :) */
         body {
         width: 1px;
         min-width: 100%;
         *width: 100%;
         }
      </style>
   </head>
   <script async>
      var dynamicColors = function() {
        var r = Math.floor(Math.random() * 255);
        var g = Math.floor(Math.random() * 255);
        var b = Math.floor(Math.random() * 255);
        return "rgb(" + r + "," + g + "," + b + ")";
      };
      
      function shadeColor(color, percent) {
        var R = parseInt(color.substring(1,3),16);
        var G = parseInt(color.substring(3,5),16);
        var B = parseInt(color.substring(5,7),16);
      
        R = parseInt(R * (100 + percent) / 100);
        G = parseInt(G * (100 + percent) / 100);
        B = parseInt(B * (100 + percent) / 100);
      
        R = (R<255)?R:255;  
        G = (G<255)?G:255;  
        B = (B<255)?B:255;  
      
        var RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
        var GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
        var BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));
      
        return "#"+RR+GG+BB;
      }
      
      function customSort(a, b) {
        return new Date(a.tradeDate).getTime() - new Date(b.tradeDate).getTime();
      }

      function getDatesInRange(startDate, endDate) {
        const date = new Date(startDate.getTime());

        const dates = [];

        while (date < endDate) {
          dates.push(formatDate(date));
          date.setDate(date.getDate() + 1);
        }

        return dates;
      }

      function formatDate(date) {
        var d = new Date(date),
            month = '' + (d.getMonth() + 1),
            day = '' + d.getDate(),
            year = d.getFullYear();

        if (month.length < 2) 
            month = '0' + month;
        if (day.length < 2) 
            day = '0' + day;

        return [year, month, day].join('-');
      }

      function convertMonthToWord(strDate, splitPoint, splitKeyword){
          var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'];
          return months[+strDate.split(splitKeyword)[splitPoint] - 1];
      }
      
      let trades = [];
      let coinWiseTrades = [];
      let sortTrades = [];
      let latestTrades = [];
      let tradedCoins = [];
      let nameToTradeMap = [];
      let symbolVsDetailsMap = [];

      let costVsTotal = [];
      let costVsTotalColor = [];
      
      let plBarChartData = [];
      
      let color = "#6a87a0";
      let lossColor = "#ff0925";
      let totalCoins = 0;
      
      if(localStorage.trades){
        trades = JSON.parse(localStorage.trades);
      }
      
      if(localStorage.coinWiseTrades){
        coinWiseTrades = JSON.parse(localStorage.coinWiseTrades);
      }

      for(let i = 0; i < trades.length; i++){
        let tradeDets = JSON.parse(trades[i]);
        if(!sortTrades[tradeDets.symbol]){
          sortTrades[tradeDets.symbol] = [];
        }

        sortTrades[tradeDets.symbol].push(tradeDets);
        symbolVsDetailsMap[tradeDets.symbol] = tradeDets["name"].toLowerCase();
      }

      for(let i in sortTrades){
        sortTrades[i].sort(customSort);
      }
      
      for(let i in coinWiseTrades){
        latestTrades[i] = JSON.parse(coinWiseTrades[i]);
        nameToTradeMap[latestTrades[i]["name"].toLowerCase()] = latestTrades[i];
        tradedCoins.push(latestTrades[i]["name"].toLowerCase());
        costVsTotal.push(latestTrades[i]["cost"]);
        plBarChartData.push(0);
        totalCoins++;
      }
      
      let tempTotal = 100 / totalCoins;
      let tempVar = 0;
      
      for(let i in latestTrades){
        costVsTotalColor.push(
          shadeColor(color, (tempVar - tempTotal))
        );
        tempVar += tempTotal
      }
      
      if(costVsTotalColor.length == 1){
        costVsTotalColor[0] = color;
      }
      
   </script>
   <body>
      <div class="container">
         <div class="row">
            <div class="col-md-3 sidebar">
               <nav class="sidebar-nav">
                  <div class="sidebar-header">
                     <button class="nav-toggler nav-toggler-md sidebar-toggler" type="button" data-toggle="collapse" data-target="#nav-toggleable-md">
                     <span class="sr-only">Toggle nav</span>
                     </button>
                     <a class="sidebar-brand img-responsive" href="index.html">
                     <span class="icon icon-credit sidebar-brand-icon"></span>
                     </a>
                  </div>
                  <div class="collapse nav-toggleable-md" id="nav-toggleable-md">
                     <ul class="nav nav-pills nav-stacked flex-column">
                        <li class="nav-header">Dashboards</li>
                        <li class="nav-item">
                           <a class="nav-link active" href="index.html">Overview</a>
                        </li>
                        <li class="nav-item">
                           <a class="nav-link " href="add/index.html">Trades</a>
                        </li>
                     </ul>
                     <hr class="visible-xs mt-3">
                  </div>
               </nav>
            </div>
            <div class="col-md-9 content">
               <div class="dashhead">
                  <div class="dashhead-titles">
                     <h6 class="dashhead-subtitle">Dashboards</h6>
                     <h2 class="dashhead-title">Overview</h2>
                  </div>
               </div>

               <div class="hr-divider my-4">
                  <h3 class="hr-divider-content hr-divider-heading">Quick stats</h3>
               </div>
               <div class="row statcards text-xs-center text-md-left" id="quickStatsHeader">
                  <div class="col-6 col-md-6 statcard mb-4"  style="text-align: center;">
                     <h3 class="statcard-number text-success">
                        <span id="top-coin-mv">0</span>
                        <small class="delta-indicator delta-positive" id="top-coin-gl">0.00%</small>
                     </h3>
                     <span class="statcard-desc" id="top-coin">Top Gainer</span>
                  </div>
                  <div class="col-6 col-md-6 statcard mb-4"  style="text-align: center;">
                     <h3 class="statcard-number text-danger">
                        <span id="loss-coin-mv">0</span>
                        <small class="delta-indicator delta-negative" id="loss-coin-gl">0.00%</small>
                     </h3>
                     <span class="statcard-desc" id="loss-coin">Worst Coin</span>
                  </div>
               </div>
               <div class="row statcards text-xs-center text-md-left" id="noTradesHeader" style="display: none">
                  <div class="col-12 col-md-12 statcard mb-4"  style="text-align: center;">
                     <span class="statcard-desc">Found no trades. Please add new trade for stats.</span>
                  </div>
               </div>

               <hr class="mt-3">
               
               <div class="row text-center mt-5" id="pieChartsHeader">
                  <div class="col-md-6 mb-6 mb-md-6">
                     <div class="w-6 mx-auto">
                        <canvas
                           class="ex-graph"
                           width="300" height="300"
                           id="costVsTotal"
                           >
                        </canvas>
                     </div>
                     <strong class="text-muted">Investment</strong>
                     <h4>Cost vs Total</h4>
                  </div>
                  <div class="col-md-6 mb-6 mb-md-6">
                     <div class="w-6 mx-auto">
                        <canvas
                           class="ex-graph"
                           width="300" height="300"
                           id="mvVsTotal"
                           >
                        </canvas>
                     </div>
                     <strong class="text-muted">Current Value</strong>
                     <h4>Market Value vs Total</h4>
                  </div>
               </div>

               <div class="hr-divider mt-5 mb-3" id="plStatementHr">
                  <h3 class="hr-divider-content hr-divider-heading">Gain - Loss Statement</h3>
               </div>
               <div class="row" id="plStatementHeader">
                  <div class="table-responsive">
                     <table class="table">
                        <thead>
                           <tr>
                              <th>Coin</th>
                              <th>Traded Price</th>
                              <th>Volume</th>
                              <th>Cost</th>
                              <th>Market Price</th>
                              <th>Market Value</th>
                              <th>GL</th>
                              <th>GL%</th>
                           </tr>
                        </thead>
                        <tbody id="tradeDetailsTableBody">
                        </tbody>
                     </table>
                  </div>
               </div>

               <div class="hr-divider mt-5 mb-3" id="plBreakdownHr">
                  <h3 class="hr-divider-content hr-divider-heading">Gain - Loss Breakdown</h3>
               </div>
               <div class="row" id="plBreakdownHeader">
                  <canvas
                     class="ex-graph"
                     width="800" height="400"
                     id="plBarChart"
                     >
                  </canvas>
               </div>
              
              <div id="plBreakdownCoinWiseHeader">
                <hr class="mt-3">
              </div>
            </div>
         </div>
      </div>
      <script src="assets/js/jquery.min.js"></script>
      <script src="assets/js/tether.min.js"></script>
      <script src="assets/js/chart.js"></script>
      <script src="assets/js/chart.zoom.js"></script>
      <script src="assets/js/tablesorter.min.js"></script>
      <script src="assets/js/toolkit.js"></script>
      <script src="assets/js/application.js"></script>
      <script>
         // execute/clear BS loaders for docs
         $(function(){while(window.BS&&window.BS.loader&&window.BS.loader.length){(window.BS.loader.pop())()}})
         
         /**
          * COIN => 
          *     [0] => {
          *       "labels" => [13th June, 14th June, 15th June....],
          *       "data" => [12, 41, 2, ...],
          *       "startingTradeDate" => "13th June, 2022"
          *     },
          *     [1] => {
          *       "labels" => [16th June, 17th June, 18th June....],
          *       "data" => [12, 41, 2, ...],
          *       "startingTradeDate" => "16th June, 2022"
          *     }
          * 
          * 
          * 
          */
         var tempChartData = [];
         let entireLabels = [];

            for(let i in sortTrades){
              /** 
               * 2 trades
               * 1 trade > 13th June
               * 2nd > 21st June
               * 
               * so from 13th to 21 > one dataset
               * 21 > current (Today minus 1) one dataset.
               * 
               * Calculation
               * Get data of coin from 13th to 21
               * If date does not exist, continue to next day untill price is found
               * that days (market price * qty subtracted by the cost) is the calculation
               * 
               * [13th June, 14th June, 15th June....]
               * [12, 41, 2, ...]
               * 
               * If two trade are on the same day
               * Add the quantity and take weighted
               * average of the unit cost.
               * 
               * ****************/

              if(!tempChartData[i]){
                tempChartData[i] = [];
              }

              let tempPriceTimeBased = [];
              let priceVsDate = [];

              $.ajax({
                type: "GET",
                async: false,
                url: `https://api.coincap.io/v2/assets/${symbolVsDetailsMap[i]}/history?interval=d1`,
                success: function(data){
                  tempPriceTimeBased = data["data"];
                  
                  for(let k in tempPriceTimeBased){
                    priceVsDate[formatDate(tempPriceTimeBased[k]["date"]).toString()] = parseFloat(tempPriceTimeBased[k]["priceUsd"]);
                  }

                  let existingVolume = 0;
                  let existingCost = 0;

                  let avgPrice = 0;

                  let values = [];

                  for(let j in sortTrades[i]){
                    let tempTradeDs = sortTrades[i][j];
                    let date = new Date(tempTradeDs.tradeDate);
                    let tempVolume = parseFloat(tempTradeDs.volume);
                    let tempCost = parseFloat(tempTradeDs.cost);

                    if(tempTradeDs.type == "buy"){
                      tempVolume += existingVolume;
                      tempCost += existingCost;

                      avgPrice = tempCost / tempVolume;
                    } else if(tempTradeDs.type == "sell"){
                      tempVolume = existingVolume - tempVolume;
                      tempCost = avgPrice * tempVolume;
                    }

                    let currentDate = new Date();
                    let nextTradeDate = new Date();

                    if(currentDate <= date){
                      continue;
                    }

                    if(sortTrades[i][parseInt(j)+1]){
                      nextTradeDate = new Date(sortTrades[i][parseInt(j)+1].tradeDate);
                    }

                    let labels = getDatesInRange(date, nextTradeDate);

                    if(j == 0){
                      entireLabels[i] = getDatesInRange(date, currentDate);

                      for(let tempDate in entireLabels[i]){
                        if(!priceVsDate[entireLabels[i][tempDate]]){
                          var index = entireLabels[i].indexOf(entireLabels[i][tempDate]);
                          if (index !== -1) {
                            entireLabels[i].splice(index, 1);
                          }
                        }
                      }
                    
                      for(let j in entireLabels[i]){
                        entireLabels[i][j] = entireLabels[i][j].split('-')[2] + " " + convertMonthToWord(entireLabels[i][j], 1, '-') + " " + entireLabels[i][j].split('-')[0];
                      }
                    }

                    for(let tempDate in labels){
                      if(!priceVsDate[labels[tempDate]]){
                        var index = labels.indexOf(labels[tempDate]);
                        if (index !== -1) {
                          labels.splice(index, 1);
                        }
                      }
                    }

                    for(let tempDate in labels){
                      values.push(
                        (tempVolume * priceVsDate[labels[tempDate]]) - tempCost
                      )
                    }

                    if(tempTradeDs.type == "buy"){
                      existingVolume += parseFloat(tempTradeDs.volume);
                      existingCost += parseFloat(tempTradeDs.cost);
                    } else if(tempTradeDs.type == "sell"){
                      existingVolume = parseFloat(tempVolume);
                    }
                  }

                  tempChartData[i].push(
                      {
                        "values": values
                      }
                  ); 
                }
              });
            }
          
          for(let i in tempChartData){
            $("#plBreakdownCoinWiseHeader").append(
              `
                <div class="row" id="PL_BREAKDOWN_COIN_WISE_${i}">
                  <canvas
                    class="ex-graph"
                    width="800" height="400"
                    id="PL_BREAKDOWN_COIN_WISE_CHART_${i}"
                  >
                  </canvas>
                </div>

               <hr class="mt-3">

              `
            )

            let tempDatasets = [];
            let tempLabels = [];

            for(let j in tempChartData[i]){
              tempLabels = entireLabels[i];
              tempDatasets.push({
                "label": i,
                "data": tempChartData[i][j]["values"],
                borderColor: "#3e95cd",
                fill: true
              })
            }

            const zoomOptions = {
                pan: {
                    enabled: true,
                    modifierKey: 'shift',
                },
                zoom: {
                    mode: 'xy',
                    drag: {
                        enabled: true,
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 1,
                        backgroundColor: 'rgba(54, 162, 235, 0.3)',
                    },
                    wheel: {
                        enabled: true
                    },
                    pan: {
                        enabled: true
                    }
                }
            };

            var growthOptions =  {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    zoom: zoomOptions,
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                var label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxTicksLimit: 10
                        },
                    },
                    y: {
                        ticks: {
                            maxTicksLimit: 10,
                            callback: function(value, index, values) {
                                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(value);
                            }
                        },
                        title: {
                            display: true,
                            align: 'center',
                            text: 'Profit',
                            padding: '5px',
                            font: {
                                size: 16
                            }
                        }
                    }
                },
            };

            // Bar chart
            var plBreakdownBarChart = new Chart(
              document.getElementById(`PL_BREAKDOWN_COIN_WISE_CHART_${i}`), 
              {
                type: 'line',
                data: {
                  labels: tempLabels,
                  datasets: tempDatasets
                },
                options: growthOptions
            });
          }

         var costVsTotalChartElement = document.getElementById("costVsTotal");
         
         var costVsTotalChart = new Chart(costVsTotalChartElement, {
           type: 'doughnut',
           data: {
             labels: tradedCoins,
             datasets: [{  
               label: 'Cost vs Total',
               data: costVsTotal,
               borderWidth: 1,
               backgroundColor: costVsTotalColor,
             }]
           },
           options: {
             plugins: {
               legend: {
                 display: false
               },
             }
           }
         });
         
         var mvVsTotalChartElement = document.getElementById("mvVsTotal");
         
         var mvVsTotalChart = new Chart(mvVsTotalChartElement, {
           type: 'doughnut',
           data: {
             labels: tradedCoins,
             datasets: [{
               label: 'Market Value vs Total',
               data: costVsTotal,
               borderWidth: 1,
               backgroundColor: costVsTotalColor,
             }]
           },
           options: {
             plugins: {
               legend: {
                 display: false
               },
             }
           }
         });
         
         // Bar chart
         var plBreakdownBarChart = new Chart(document.getElementById("plBarChart"), {
           type: 'bar',
           data: {
             labels: tradedCoins,
             datasets: [
               {
                 label: "Gain - Loss",
                 backgroundColor: costVsTotalColor,
                 data: plBarChartData
               }
             ]
           }
         });
         
         if(trades.length == 0){
           $('#quickStatsHeader').hide();
           $('#pieChartsHeader').hide();
           $('#plStatementHeader').hide();
           $("#plStatementHr").hide();
           $("#plBreakdownHr").hide();
           $("#plBreakdownHeader").hide();
           $("#plBreakdownCoinWiseHeader").hide();
           $('#noTradesHeader').show();
         } else {
           let totalCostOfAllCoins = 0;
         
           for(let coin in latestTrades){
             let tradeDetails = latestTrades[coin];
             tradeDetails.name = tradeDetails.name.toLowerCase();
             
             totalCostOfAllCoins += parseFloat(tradeDetails.cost);
         
             $("#tradeDetailsTableBody").append(
               `     
                 <tr id='STATEMENT_${tradeDetails.name}'>
                   <td>${tradeDetails.symbol}</td>
                   <td>$${tradeDetails.price}</td>
                   <td>${tradeDetails.volume} ${tradeDetails.symbol}</td>
                   <td>$${tradeDetails.cost}</td>
                   <td id='MP_${tradeDetails.name}'>${tradeDetails.price}</td>
                   <td id='MV_${tradeDetails.name}'>${tradeDetails.cost}</td>
                   <td id='GL_${tradeDetails.name}'>0</td>
                   <td id='GLP_${tradeDetails.name}'>0.00</td>
                 </tr>
               `
             );
           }
         
           totalCostOfAllCoins = totalCostOfAllCoins.toFixed(2);
           $("#tradeDetailsTableBody").append(
             `     
               <tr id='STATEMENT_TOTAL'>
                 <td></td>
                 <td></td>
                 <td></td>
                 <td>$${totalCostOfAllCoins}</td>
                 <td></td>
                 <td id='MV_TOTAL'>${totalCostOfAllCoins}</td>
                 <td id='GL_TOTAL'>0</td>
                 <td id='GLP_TOTAL'>0.00</td>
               </tr>
             `
           );
         
           let latestGl = [];
           let latestGlP = [];
         
           const pricesWs = new WebSocket('wss://ws.coincap.io/prices?assets=' + tradedCoins.join(','))
         
           pricesWs.onmessage = function (msg) {
             let updatedPrice = JSON.parse(msg.data);
             for(let i in updatedPrice){
               let temp = tradedCoins.indexOf(i);
               mvVsTotalChart.data.datasets[0].data[temp] = updatedPrice[i] * nameToTradeMap[i]["volume"];
               mvVsTotalChart.update();
         
               let prevMv = parseFloat($("#MV_" + i).text());
               let prevGl = parseFloat($("#GL_" + i).text());
               let prevGlP = parseFloat($("#GLP_" + i).text());
         
               let newMv = (updatedPrice[i] * nameToTradeMap[i]["volume"]);
               let newGl = (parseFloat(newMv) - nameToTradeMap[i]["cost"]);
               let newGlP = ((parseFloat(newGl) / nameToTradeMap[i]["cost"]) * 100);
         
               plBreakdownBarChart.data.datasets[0].data[temp] = newGl;
               plBreakdownBarChart.update();
         
               $("#MP_" + i).text(updatedPrice[i]);
               $("#MV_" + i).text(newMv);
               $("#GL_" + i).text(newGl);
               $("#GLP_" + i).text(newGlP);
         
               if(parseFloat(newGl) < 0){
                 $("#STATEMENT_" + i).css("background-color", "#E64759");
               } else {
                 $("#STATEMENT_" + i).css("background-color", "green");
               }
         
               $("#MV_TOTAL").text(((parseFloat($("#MV_TOTAL").text()) - prevMv) + parseFloat(newMv)));
               $("#GL_TOTAL").text(((parseFloat($("#GL_TOTAL").text()) - prevGl) + parseFloat(newGl)));
               $("#GLP_TOTAL").text(((parseFloat($("#GLP_TOTAL").text()) - prevGlP) + parseFloat(newGlP)));
         
               if(!latestGl[i]){
                 latestGl[i] = "";
               }
         
               latestGl[i] = newGl;
         
               if(!latestGlP[i]){
                 latestGlP[i] = "";
               }
         
               latestGlP[i] = newGlP;
         
               let bestCoin = 'No gainer';
               let bestGlTemp = 0;
         
               let worstCoin = 'No loser';
               let worstGlTemp = 0;
         
               for(let j in latestGl){
                 if(bestGlTemp < latestGl[j]){
                   bestGlTemp = latestGl[j]
                   bestCoin = j
                 }
         
                 if(worstGlTemp > latestGl[j]){
                   worstGlTemp = latestGl[j]
                   worstCoin = j
                 }
               }
         
               if(bestCoin == "No gainer"){
                 $("#top-coin-mv").text(0);
                 $("#top-coin").text("No Gainer");
                 $("#top-coin-gl").text("0.00%");
               } else {
                 $("#top-coin-mv").text(latestGl[bestCoin].toFixed(2));
                 $("#top-coin").text("Gainer - " + bestCoin);
                 $("#top-coin-gl").text(latestGlP[bestCoin].toFixed(2) + "%");
               }
         
               if(worstCoin == "No loser"){
                 $("#loss-coin-mv").text(0);
                 $("#loss-coin").text("No Loser");
                 $("#loss-coin-gl").text("0.00%");
               } else {
                 $("#loss-coin-mv").text(latestGl[worstCoin].toFixed(2));
                 $("#loss-coin").text("Loser - " + worstCoin);
                 $("#loss-coin-gl").text(latestGlP[worstCoin].toFixed(2) + "%");
               }
             }
           }
         }
      </script>
   </body>
</html>