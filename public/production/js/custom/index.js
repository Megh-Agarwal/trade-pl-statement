let trades=[],coinWiseTrades=[],sortTrades=[],latestTrades=[],tradedCoins=[],nameToTradeMap=[],symbolVsDetailsMap=[],costVsTotal=[],costVsTotalColor=[],plBarChartData=[],color="#6a87a0",lossColor="#ff0925",totalCoins=0;localStorage.trades&&(trades=JSON.parse(localStorage.trades)),localStorage.coinWiseTrades&&(coinWiseTrades=JSON.parse(localStorage.coinWiseTrades));for(let e=0;e<trades.length;e++){let t=JSON.parse(trades[e]);sortTrades[t.symbol]||(sortTrades[t.symbol]=[]),sortTrades[t.symbol].push(t),symbolVsDetailsMap[t.symbol]=t.name.toLowerCase()}for(let t in sortTrades)sortTrades[t].sort(customSort);for(let t in coinWiseTrades)latestTrades[t]=JSON.parse(coinWiseTrades[t]),nameToTradeMap[latestTrades[t].name.toLowerCase()]=latestTrades[t],tradedCoins.push(latestTrades[t].name.toLowerCase()),costVsTotal.push(latestTrades[t].cost),plBarChartData.push(0),totalCoins++;let tempTotal=100/totalCoins,tempVar=0;for(let t in latestTrades)costVsTotalColor.push(shadeColor(color,tempVar-tempTotal)),tempVar+=tempTotal;1==costVsTotalColor.length&&(costVsTotalColor[0]=color);var tempChartData=[];let entireLabels=[];for(let g in sortTrades){tempChartData[g]||(tempChartData[g]=[]);let a=[],u=[];$.ajax({type:"GET",async:!1,url:`https://api.coincap.io/v2/assets/${symbolVsDetailsMap[g]}/history?interval=d1`,success:function(t){for(var e in a=t.data)u[formatDate(a[e].date).toString()]=parseFloat(a[e].priceUsd);let s=0,r=0,l=0,d=[];for(var n in sortTrades[g]){var i=sortTrades[g][n],p=new Date(i.tradeDate);let e=parseFloat(i.volume),a=parseFloat(i.cost);"buy"==i.type?(e+=s,a+=r,l=a/e):"sell"==i.type&&(e=s-e,a=l*e);var c,T=new Date;let o=new Date;if(!(T<=p)){sortTrades[g][parseInt(n)+1]&&(o=new Date(sortTrades[g][parseInt(n)+1].tradeDate));let t=getDatesInRange(p,o);if(0==n){for(var m in entireLabels[g]=getDatesInRange(p,T),entireLabels[g])u[entireLabels[g][m]]||-1!==(c=entireLabels[g].indexOf(entireLabels[g][m]))&&entireLabels[g].splice(c,1);for(var h in entireLabels[g])entireLabels[g][h]=entireLabels[g][h].split("-")[2]+" "+convertMonthToWord(entireLabels[g][h],1,"-")+" "+entireLabels[g][h].split("-")[0]}if(0==t.length)"buy"==i.type?(s+=parseFloat(i.volume),r+=parseFloat(i.cost)):"sell"==i.type&&(s=parseFloat(e),r-=parseFloat(a));else{for(var C in t)u[t[C]]||-1!==(c=t.indexOf(t[C]))&&t.splice(c,1);for(var b in t)d.push(e*u[t[b]]-a);"buy"==i.type?(s+=parseFloat(i.volume),r+=parseFloat(i.cost)):"sell"==i.type&&(s=parseFloat(e),r-=parseFloat(a))}}}tempChartData[g].push({values:d})}})}for(let o in tempChartData){$("#plBreakdownCoinWiseHeader").append(`
        <div class="row" id="PL_BREAKDOWN_COIN_WISE_${o}">
            <canvas
            class="ex-graph"
            width="800" height="400"
            id="PL_BREAKDOWN_COIN_WISE_CHART_${o}"
            >
            </canvas>
        </div>

        <hr class="mt-3">

        `);let e=[],a=[];for(let t in tempChartData[o])a=entireLabels[o],e.push({label:o,data:tempChartData[o][t].values,borderColor:"#3e95cd",fill:!0});const E={pan:{enabled:!0,modifierKey:"shift"},zoom:{mode:"xy",drag:{enabled:!0,borderColor:"rgb(54, 162, 235)",borderWidth:1,backgroundColor:"rgba(54, 162, 235, 0.3)"},wheel:{enabled:!0},pan:{enabled:!0}}};var growthOptions={responsive:!0,maintainAspectRatio:!1,plugins:{zoom:E,tooltip:{callbacks:{label:function(t){var e=t.dataset.label||"";return e&&(e+=": "),null!==t.parsed.y&&(e+=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:2}).format(t.parsed.y)),e}}}},scales:{x:{ticks:{maxTicksLimit:10}},y:{ticks:{maxTicksLimit:10,callback:function(t,e,a){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:2}).format(t)}},title:{display:!0,align:"center",text:"Profit",padding:"5px",font:{size:16}}}}},plBreakdownBarChart=new Chart(document.getElementById("PL_BREAKDOWN_COIN_WISE_CHART_"+o),{type:"line",data:{labels:a,datasets:e},options:growthOptions})}var costVsTotalChartElement=document.getElementById("costVsTotal"),costVsTotalChart=new Chart(costVsTotalChartElement,{type:"doughnut",data:{labels:tradedCoins,datasets:[{label:"Cost vs Total",data:costVsTotal,borderWidth:1,backgroundColor:costVsTotalColor}]},options:{plugins:{legend:{display:!1}}}}),mvVsTotalChartElement=document.getElementById("mvVsTotal"),mvVsTotalChart=new Chart(mvVsTotalChartElement,{type:"doughnut",data:{labels:tradedCoins,datasets:[{label:"Market Value vs Total",data:costVsTotal,borderWidth:1,backgroundColor:costVsTotalColor}]},options:{plugins:{legend:{display:!1}}}}),plBreakdownBarChart=new Chart(document.getElementById("plBarChart"),{type:"bar",data:{labels:tradedCoins,datasets:[{label:"Gain - Loss",backgroundColor:costVsTotalColor,data:plBarChartData}]}});if(0==trades.length)$("#quickStatsHeader").hide(),$("#pieChartsHeader").hide(),$("#plStatementHeader").hide(),$("#plStatementHr").hide(),$("#plBreakdownHr").hide(),$("#plBreakdownHeader").hide(),$("#plBreakdownCoinWiseHeader").hide(),$("#noTradesHeader").show();else{let a=0;for(let e in latestTrades){let t=latestTrades[e];t.name=t.name.toLowerCase(),a+=parseFloat(t.cost),$("#tradeDetailsTableBody").append(`     
                <tr id='STATEMENT_${t.name}'>
                <td>${t.symbol}</td>
                <td>$${t.price}</td>
                <td>${t.volume} ${t.symbol}</td>
                <td>$${t.cost}</td>
                <td id='MP_${t.name}'>${t.price}</td>
                <td id='MV_${t.name}'>${t.cost}</td>
                <td id='GL_${t.name}'>0</td>
                <td id='GLP_${t.name}'>0.00</td>
                </tr>
            `)}a=a.toFixed(2),$("#tradeDetailsTableBody").append(`     
            <tr id='STATEMENT_TOTAL'>
                <td></td>
                <td></td>
                <td></td>
                <td>$${a}</td>
                <td></td>
                <td id='MV_TOTAL'>${a}</td>
                <td id='GL_TOTAL'>0</td>
                <td id='GLP_TOTAL'>0.00</td>
            </tr>
        `);let h=[],C=[];const O=new WebSocket("wss://ws.coincap.io/prices?assets="+tradedCoins.join(","));O.onmessage=function(t){var s,r=JSON.parse(t.data);for(s in r){var l,d=tradedCoins.indexOf(s),n=(mvVsTotalChart.data.datasets[0].data[d]=r[s]*nameToTradeMap[s].volume,mvVsTotalChart.update(),parseFloat($("#MV_"+s).text())),i=parseFloat($("#GL_"+s).text()),p=parseFloat($("#GLP_"+s).text()),c=r[s]*nameToTradeMap[s].volume,T=parseFloat(c)-nameToTradeMap[s].cost,m=parseFloat(T)/nameToTradeMap[s].cost*100;plBreakdownBarChart.data.datasets[0].data[d]=T,plBreakdownBarChart.update(),$("#MP_"+s).text(r[s]),$("#MV_"+s).text(c),$("#GL_"+s).text(T),$("#GLP_"+s).text(m),parseFloat(T)<0?$("#STATEMENT_"+s).css("background-color","#E64759"):$("#STATEMENT_"+s).css("background-color","green"),$("#MV_TOTAL").text(parseFloat($("#MV_TOTAL").text())-n+parseFloat(c)),$("#GL_TOTAL").text(parseFloat($("#GL_TOTAL").text())-i+parseFloat(T)),$("#GLP_TOTAL").text(parseFloat($("#GLP_TOTAL").text())-p+parseFloat(m)),h[s]||(h[s]=""),h[s]=T,C[s]||(C[s]=""),C[s]=m;let t="No gainer",e=0,a="No loser",o=0;for(l in h)e<h[l]&&(e=h[l],t=l),o>h[l]&&(o=h[l],a=l);"No gainer"==t?($("#top-coin-mv").text(0),$("#top-coin").text("No Gainer"),$("#top-coin-gl").text("0.00%")):($("#top-coin-mv").text(h[t].toFixed(2)),$("#top-coin").text("Gainer - "+t),$("#top-coin-gl").text(C[t].toFixed(2)+"%")),"No loser"==a?($("#loss-coin-mv").text(0),$("#loss-coin").text("No Loser"),$("#loss-coin-gl").text("0.00%")):($("#loss-coin-mv").text(h[a].toFixed(2)),$("#loss-coin").text("Loser - "+a),$("#loss-coin-gl").text(C[a].toFixed(2)+"%"))}}}