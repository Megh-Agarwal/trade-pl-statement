<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta name="author" content="">

  <title>
    $ - Trades
  </title>

  <link href="../assets/css/toolkit-inverse.css" rel="stylesheet">
  <link href="../assets/css/application.css" rel="stylesheet">
  <link href="../assets/css/typeahead.css" rel="stylesheet" />
  <link href="../assets/css/pnotify.css" rel="stylesheet" />
<style>
  /* note: this is a hack for ios iframe for bootstrap themes shopify page */
  /* this chunk of css is not part of the toolkit :) */
  body {
    width: 1px;
    min-width: 100%;
    *width: 100%;
  }
</style>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col-md-3 sidebar">
        <nav class="sidebar-nav">
          <div class="sidebar-header">
            <button class="nav-toggler nav-toggler-md sidebar-toggler" type="button" data-toggle="collapse" data-target="#nav-toggleable-md">
              <span class="sr-only">Toggle nav</span>
            </button>
            <a class="sidebar-brand img-responsive" href="index.html">
              <span class="icon icon-credit sidebar-brand-icon"></span>
            </a>
          </div>

          <div class="collapse nav-toggleable-md" id="nav-toggleable-md">
            <ul class="nav nav-pills nav-stacked flex-column">
              <li class="nav-header">Dashboards</li>
              <li class="nav-item">
                <a class="nav-link" href="../index.html">Overview</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="add/index.html">Trades</a>
              </li>
            </ul>
            <hr class="visible-xs mt-3">
          </div>
        </nav>
      </div>
      <div class="col-md-9 content">
        <div class="dashhead">
          <div class="dashhead-titles">
            <h6 class="dashhead-subtitle">Trades</h6>
            <h2 class="dashhead-title">Completed trades</h2>
          </div>
        </div>

        <div class="flextable table-actions">
          <div class="flextable-item flextable-primary">
            <div class="btn-toolbar-item input-with-icon">
              <input type="text" id="search" class="form-control input-block" placeholder="Search Trades">
              <span class="icon icon-magnifying-glass"></span>
            </div>
          </div>
          <div class="flextable-item">
            <div class="btn-group">
              <button type="button" class="btn btn-outline-primary" data-toggle="modal" href="#addNewTradeModal" >
                <span class="icon icon-plus"></span>
              </button>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Coin</th>
                <th>Type</th>
                <th>Traded Price</th>
                <th>Volume</th>
                <th>Cost</th>
                <th>Date</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="tradeDetailsTableBody">
            </tbody>
          </table>
        </div>

        <div class="text-center">
          <nav>
            <ul class="pagination">
            </ul>
          </nav>
        </div>

      </div>
    </div>
  </div>

  <div id="addNewTradeModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="myModalLabel">Add new trade</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group">
              <label for="investedCoin">Coin</label>
              <input type="text" class="form-control typeahead" id="investedCoin">
              <small id="autocomplete" class="form-text text-muted">Please type in the coin name.</small>
            </div>
            <div class="form-group">
              <label for="tradeType">Trade Type</label>
              <select class="form-control" id="tradeType" aria-label="Trade Type">
                <option value="buy" selected>Buy</option>
                <option value="sell">Sell</option>
              </select>
            </div>
            <div class="form-group">
              <label for="price">Price</label>
              <input type="number" class="form-control" id="price">
            </div>
            <div class="form-group">
              <label for="volume">Volume</label>
              <input type="number" class="form-control" id="volume">
            </div>
            <div class="form-group">
              <label for="tradeDate">Trade Date</label>
              <input type="date" class="form-control" id="tradeDate">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="addNewTradeButton">Add trade</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="editTradeModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="myModalLabel">Edit Trade</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group">
              <label for="investedCoin">Coin</label>
              <input disabled type="text" class="form-control typeahead" id="editInvestedCoin">
              <small id="autocomplete" class="form-text text-muted">Please type in the coin name.</small>
            </div>
            <div class="form-group">
              <label for="tradeType">Trade Type</label>
              <select disabled class="form-control" id="editTradeType" aria-label="Trade Type">
                <option value="buy" selected>Buy</option>
                <option value="sell">Sell</option>
              </select>
            </div>
            <div class="form-group">
              <label for="price">Price</label>
              <input type="number" class="form-control" id="editPrice">
            </div>
            <div class="form-group">
              <label for="volume">Volume</label>
              <input type="number" class="form-control" id="editVolume">
            </div>
            <div class="form-group">
              <label for="tradeDate">Trade Date</label>
              <input type="date" class="form-control" id="editTradeDate">
            </div>
            <div class="form-group">
              <input type="text" hidden class="form-control" id="tradeId">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="editTradeButton">Edit trade</button>
        </div>
      </div>
    </div>
  </div>

  <script src="../assets/js/jquery.min.js"></script>
  <script src="../assets/js/tether.min.js"></script>
  <script src="../assets/js/chart.js"></script>
  <script src="../assets/js/tablesorter.min.js"></script>
  <script src="../assets/js/toolkit.js"></script>
  <script src="../assets/js/application.js"></script>
  <script src="../assets/js/typeahead.js"></script>
  <script src="../assets/js/pnotify.min.js"></script>
  <script>
    // execute/clear BS loaders for docs
    $(function(){while(window.BS&&window.BS.loader&&window.BS.loader.length){(window.BS.loader.pop())()}})

    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    
    var coinsList = [];
    var coinsSymbols = [];

    let trades = [];
    if(localStorage.trades){
      trades = JSON.parse(localStorage.trades);
    }

    $.ajax({
      type: "GET",
      url: "https://api.coincap.io/v2/assets?limit=2000",
      success: function(data){
        for(let i = 0; i < data["data"].length; i++){
          coinsList.push(data["data"][i]["name"] + ' - ' + data["data"][i]["symbol"]);
          coinsSymbols[data["data"][i]["symbol"]] = data["data"][i];
        }

        $("#investedCoin").typeahead({
          hint: true,
          highlight: true,
          minLength: 1,
          name: "coins",
          source: coinsList
        });
      }
    });

    for(let i = 0; i < trades.length; i++){
      let tradeDetails = JSON.parse(trades[i]);
      $("#tradeDetailsTableBody").append(
        `     
          <tr>
            <td>${tradeDetails.coin}</td>
            <td>${capitalizeFirstLetter(tradeDetails.type)}</td>
            <td>$${tradeDetails.price}</td>
            <td>${tradeDetails.volume} ${tradeDetails.symbol}</td>
            <td>$${tradeDetails.cost}</td>
            <td>${new Date(tradeDetails.tradeDate).toLocaleDateString()}</td>
            <td>
              <button type="button" class="btn btn-outline-primary" onclick='editTradeOpenModal(${tradeDetails.id})'>
                <span class="icon icon-edit"></span>
              </button>
            </td>
          </tr>
        `
      );
    }

    function editTradeOpenModal(id){
      for(let i = 0; i < trades.length; i++){
        let tradeDetails = JSON.parse(trades[i]);
        if(tradeDetails.id == id){
          $("#editInvestedCoin").val(tradeDetails.coin);
          $("#editTradeType").val(tradeDetails.type);
          $("#editPrice").val(tradeDetails.price);
          $("#editVolume").val(tradeDetails.volume);
          $("#editTradeDate").val(tradeDetails.tradeDate);
          $("#tradeId").val(id);
          $("#editTradeModal").modal('show');
        }
      }
    }

    var $rows = $('#tradeDetailsTableBody tr');
    $('#search').keyup(function() {
        var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();

        $rows.show().filter(function() {
            var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
            return !~text.indexOf(val);
        }).hide();
    });

    $("#editTradeButton").on('click', function(e){
      let coin = $("#editInvestedCoin").val();
      let tradeType = $("#editTradeType").val();
      let price = $("#editPrice").val();
      let volume = $("#editVolume").val();
      let tradeDate = $("#editTradeDate").val();

      if(coin == ""){
        PNotify.error({
          title: "An error occured",
          text: "Found invested coin value as empty. Please enter the invested coin."
        })
        
        return false;
      }
      
      if(price == "" || !isNumber(price)){
        PNotify.error({
          title: "An error occured",
          text: "Found invalid pricing value. Please enter a valid price at which the volume was traded."
        })
        
        return false;
      }
      
      if(volume == "" || !isNumber(volume)){
        PNotify.error({
          title: "An error occured",
          text: "Found invalid volume value. Please enter a valid invested volume (quantity)."
        })
        
        return false;
      }

      if(tradeDate == ""){
        PNotify.error({
          title: "An error occured",
          text: "Found invalid trade date value. Please select a valid trade date."
        })
        
        return false;
      }

      let coinSymbol = coin.split('-');
      coinSymbol = coinSymbol[coinSymbol.length - 1].trim();

      if(coinSymbol == ""){
        PNotify.error({
          title: "An error occured",
          text: `Found invalid coin name.`
        })
        
        return false;
      }

      if(!isset(coinsSymbols, coinSymbol)){
        PNotify.error({
          title: "An error occured",
          text: `Found no coin with symbol as ${coinSymbol}.`
        })
        
        return false;
      }

      let coinWiseTrades = {};
      if(localStorage.coinWiseTrades){
        coinWiseTrades = JSON.parse(localStorage.coinWiseTrades);
      }

      if(tradeType == "sell"){
        if(!coinWiseTrades[coinSymbol]){
          PNotify.error({
            title: "An error occured",
            text: `You have no holding for coin with symbol as ${coinSymbol} to sell ${volume} ${coinSymbol}.`
          })
          
          return false;
        }

        let holdingOfCoin = JSON.parse(coinWiseTrades[coinSymbol]);
        let currentVolumeHolding = parseFloat(holdingOfCoin.volume);

        if(currentVolumeHolding < volume){
          PNotify.error({
            title: "An error occured",
            text: `You have only ${currentVolumeHolding} ${coinSymbol} to sell.`
          })
          
          return false;
        }
      }
      
      for(let i = 0; i < trades.length; i++){
        let tradeDetails = JSON.parse(trades[i]);
        if(tradeDetails.id == $("#tradeId").val()){
          tradeDetails.price = price;
          tradeDetails.volume = volume;
          tradeDetails.tradeDate = tradeDate;
          tradeDetails.cost = (price * volume).toFixed(2);
        }
        trades[i] = JSON.stringify(tradeDetails);
      }

      localStorage.setItem('trades', JSON.stringify(trades));

      let totalCost = 0.00;
      let totalVolume = 0;

      let totalSoldQty = 0;

      for(let i = 0; i < trades.length; i++){
        let tradeDetails = JSON.parse(trades[i]);
        if(tradeDetails.symbol == coinSymbol){
          if(tradeDetails.type == "buy") {
            totalVolume = totalVolume + parseFloat(tradeDetails.volume);
            totalCost = totalCost + parseFloat(tradeDetails.cost);
          }

          if(tradeDetails.type == "sell") {
            totalSoldQty = totalSoldQty + parseFloat(tradeDetails.volume);
          }
        }
      }

      let avgPrice = totalCost / totalVolume;

      let tempVar =  {
        "symbol": coinSymbol,
        "price": avgPrice,
        "volume": totalVolume - totalSoldQty,
        "cost": avgPrice * (totalVolume - totalSoldQty),
        "name": coinsSymbols[coinSymbol]["name"],
      };

      if(!coinWiseTrades[coinSymbol]){
        coinWiseTrades[coinSymbol] = {};
      }

      coinWiseTrades[coinSymbol] = JSON.stringify(tempVar)

      localStorage.setItem('coinWiseTrades', JSON.stringify(coinWiseTrades));
      
      PNotify.success({
        title: "Success",
        text: `The trade was successfully edited.`
      })

      setTimeout(function() {
        location.reload();
      }, 1000)
    })

    $("#addNewTradeButton").on('click', function(e){
      let coin = $("#investedCoin").val();
      let tradeType = $("#tradeType").val();
      let price = $("#price").val();
      let volume = $("#volume").val();
      let tradeDate = $("#tradeDate").val();

      if(coin == ""){
        PNotify.error({
          title: "An error occured",
          text: "Found invested coin value as empty. Please enter the invested coin."
        })
        
        return false;
      }

      if(tradeType == "" || (tradeType != "buy" && tradeType != "sell")){
        PNotify.error({
          title: "An error occured",
          text: "Found invalid trade type. Please select a trade type."
        })
        
        return false;
      }
      
      if(price == "" || !isNumber(price)){
        PNotify.error({
          title: "An error occured",
          text: "Found invalid pricing value. Please enter a valid price at which the volume was traded."
        })
        
        return false;
      }
      
      if(volume == "" || !isNumber(volume)){
        PNotify.error({
          title: "An error occured",
          text: "Found invalid volume value. Please enter a valid invested volume (quantity)."
        })
        
        return false;
      }

      if(tradeDate == ""){
        PNotify.error({
          title: "An error occured",
          text: "Found invalid trade date value. Please select a valid trade date."
        })
        
        return false;
      }

      let coinSymbol = coin.split('-');
      coinSymbol = coinSymbol[coinSymbol.length - 1].trim();

      if(coinSymbol == ""){
        PNotify.error({
          title: "An error occured",
          text: `Found invalid coin name.`
        })
        
        return false;
      }

      if(!isset(coinsSymbols, coinSymbol)){
        PNotify.error({
          title: "An error occured",
          text: `Found no coin with symbol as ${coinSymbol}.`
        })
        
        return false;
      }

      let coinWiseTrades = {};
      if(localStorage.coinWiseTrades){
        coinWiseTrades = JSON.parse(localStorage.coinWiseTrades);
      }

      if(tradeType == "sell"){
        if(!coinWiseTrades[coinSymbol]){
          PNotify.error({
            title: "An error occured",
            text: `You have no holding for coin with symbol as ${coinSymbol} to sell ${volume} ${coinSymbol}.`
          })
          
          return false;
        }

        let holdingOfCoin = JSON.parse(coinWiseTrades[coinSymbol]);
        let currentVolumeHolding = parseFloat(holdingOfCoin.volume);

        if(currentVolumeHolding < volume){
          PNotify.error({
            title: "An error occured",
            text: `You have only ${currentVolumeHolding} ${coinSymbol} to sell.`
          })
          
          return false;
        }
      }

      trades.push(JSON.stringify({
        "id": Date.now(),
        "symbol": coinSymbol,
        "type": tradeType,
        "coin": coin,
        "price": price,
        "volume": volume,
        "tradeDate": tradeDate,
        "name": coinsSymbols[coinSymbol]["name"],
        "cost": (price * volume).toFixed(2)
      }));

      localStorage.setItem('trades', JSON.stringify(trades));

      let totalCost = 0.00;
      let totalVolume = 0;

      let totalSoldQty = 0;

      for(let i = 0; i < trades.length; i++){
        let tradeDetails = JSON.parse(trades[i]);
        if(tradeDetails.symbol == coinSymbol){
          if(tradeDetails.type == "buy") {
            totalVolume = totalVolume + parseFloat(tradeDetails.volume);
            totalCost = totalCost + parseFloat(tradeDetails.cost);
          }

          if(tradeDetails.type == "sell") {
            totalSoldQty = totalSoldQty + parseFloat(tradeDetails.volume);
          }
        }
      }

      let avgPrice = totalCost / totalVolume;

      let tempVar =  {
        "symbol": coinSymbol,
        "price": avgPrice,
        "volume": totalVolume - totalSoldQty,
        "cost": avgPrice * (totalVolume - totalSoldQty),
        "name": coinsSymbols[coinSymbol]["name"],
      };

      if(!coinWiseTrades[coinSymbol]){
        coinWiseTrades[coinSymbol] = {};
      }

      coinWiseTrades[coinSymbol] = JSON.stringify(tempVar)

      localStorage.setItem('coinWiseTrades', JSON.stringify(coinWiseTrades));
      
      PNotify.success({
        title: "Success",
        text: `The trade was successfully added.`
      })

      setTimeout(function() {
        location.reload();
      }, 1000)
    });
  </script>
  </body>
</html>

